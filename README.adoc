// Copyright (c) 2017 IBM Corporation and others.
// Licensed under Creative Commons Attribution-NoDerivatives
// 4.0 International (CC BY-ND 4.0)
//   https://creativecommons.org/licenses/by-nd/4.0/
//
// Contributors:
//   IBM Corporation
:projectid: microprofile-opentracing
:page-layout: guide
:page-duration: 15 minutes
// :page-releasedate: 2017-12-11
:page-description: Learn how to enable and customize tracing of JAX-RS and non JAX-RS methods using MicroProfile OpenTracing.
:page-tags: ['MicroProfile', 'OpenTracing', 'microservices', '@Traced']
:page-permalink: /guides/{projectid}
:page-related-guides: ['cdi-intro']
:common-includes: https://raw.githubusercontent.com/OpenLiberty/guides-common/master
:source-highlighter: prettify
= Enabling distributed tracing in microservices

Learn how to enable and customize tracing of JAX-RS and non JAX-RS methods using MicroProfile OpenTracing.


:inv-url: http://localhost:9081/inventory/systems
:inv-url-docker: http://localhost:9080/inventory/systems
:sys-url: http://localhost:9080/system/properties
:zipkin-url: http://localhost:9411


== What you'll learn

You will learn how to enable automatic tracing for JAX-RS methods as well as create custom tracers
for non JAX-RS methods using MicroProfile OpenTracing.

OpenTracing is a standard API for instrumenting microservices for distributed tracing. Distributed
tracing helps troubleshoot microservices by examining and logging requests as they propagate through a
distributed system, allowing developers to tackle otherwise difficult task of debugging these requests.
Without a distributed tracing system in place, it becomes extremely difficult to analyze the workflows of
operations, in particular, being able to pinpoint when and by whom a request is received, as well as
when a response is sent back.

MicroProfile OpenTracing aims to enable distributed tracing in MicroProfile applications without having
to add any explicit distributed tracing code to the application. Note that the MicroProfile OpenTracing
specification does not address the problem of defining, implementing, or configuring the underlying
distributed tracing system. Rather, it makes it easy to instrument services with distributed tracing
given an existing distributed tracing system.

You will configure the provided `inventory` and `system` services to make use of distributed tracing
using MicroProfile OpenTracing. You will run these services in two separate JVMs (two server instances)
in order to better demonstrate tracing in a distributed environment. If everything were to run on a single
server, then any logging software would do the trick.


// =================================================================================================
// Getting Started
// =================================================================================================

//include::{common-includes}/gitclone.adoc[]
include::{common-includes}/gitclonedraft.adoc[]

For the purposes of this guide, we are using Zipkin as our distributed tracing system. You can find the
installation instructions for Zipkin https://zipkin.io/pages/quickstart.html[here]. You are not
restricted to using Zipkin, but keep in mind that you may need additional instructions not listed here
if you choose to use another tracing system.

Before you proceed, make sure your Zipkin server is up and running. By default, Zipkin can be found at {zipkin-url}.


=== Try what you'll build

**BEFORE YOU PROCEED. DOWNLOAD THE 18.0.0.1 OPEN LIBERTY GM AND PLACE IT UNDER wlp.zip UNDER THE ROOT DIRECTORY OF THIS GUIDE; ie. draft-guide-microprofile-opentracing/wlp.zip**

The `finish` directory in the root directory of this guide contains two services that have been configured
to use MicroProfile OpenTracing. Feel free to give them a try before you proceed.

To try out the services, navigate to the `finish` directory and then run the Maven `install` and
`liberty:start-server` goals to build the services and run them in two Open Liberty servers:

```
cd finish
mvn install
mvn liberty:start-server
```

Make sure your Zipkin server is running and point your browser to {inv-url}/localhost. When you visit
this endpoint, you make two GET HTTP requests, one to the `system` service and one to the `inventory`
service. Both of these requests have been configured to be traced, so a new trace will recorded in Zipkin.
Visit {zipkin-url} (or where you configured Zipkin to run) and verify that this new trace contains
four spans named:

- `get:io.openliberty.guides.inventory.inventoryresource.getpropertiesforhost`
- `get`
- `get:io.openliberty.guides.system.systemresource.getproperties`
- `addtoinventory() span`

Each span can also be inspected by clicking on it to reveal more detailed information such as the time
at which the request was received and the time at which a response was sent back.

Once you are done checking out the services, stop both Open Liberty servers:

```
mvn liberty:stop-server
```

// =================================================================================================
// Running the application with Docker
// =================================================================================================

// == Running the services
//
// Before you begin, you must build and run the `inventory` and `system` services. You must also start
// your Zipkin server (or another tracing system of your choice). You have two options for doing this:
//
// - Running everything inside Docker containers
// - Running the two services outside of Docker in two separate Open Liberty servers
//
//
// === Running with Docker
//
// *THIS DOES NOT WORK AS OF MARCH 2, 2018 BECAUSE IT REQUIRES OL 18.0.0.1 WHICH IS NOT A PART OF ANY DOCKER IMAGE*
//
// If you are using Docker to run your Zipkin server and you would prefer running your services with Docker
// as well, then follow these instructions:
//
// A `Dockerfile` and a `docker-compose.yaml` are provided under the `docker` directory in the root directory
// of this guide. Navigate to this directory and build your services:
//
// ```
// cd docker
// mvn package
// ```
//
// Stop your Zipkin container if you have previously started it, then run the following command:
//
// ```
// docker-compose up -d
// ```
//
// This command picks up the `Dockerfile` and the `docker-compose.yaml` and builds a Docker image containing
// the Open Liberty runtime. Three containers are also built and started alongside the image: one for the
// `system` service, one for the `inventory` service, and one for the Zipkin server.
//
// Once the containers are running, the `inventory` service can be reached at {inv-url-docker} and the Zipkin server at
// {zipkin-url}. To retrieve the JVM system properties of the container running the `system` service, point
// to {inv-url-docker}/sys (all containers are linked and therefore they can access each other by their container names).
//
// Feel free to read our https://openliberty.io/guides/docker.html[Docker guide] to learn more about developing
// applications with Open Liberty and Docker.
//
//
// === Running the services outside of Docker
//
// Navigate to the `start` directory, then build the services and run them in Open Liberty:
//
// ```
// cd start
// mvn install liberty:start-server
// ```
//
// You can find the `inventory` and `system` services at:
//
// - {inv-url}
// - {sys-url}
//
// include::{common-includes}/mvnpackage.adoc[]


// =================================================================================================
// Running the services
// =================================================================================================

== Running the services

Before you proceed, build and start the provided `system` and `inventory` services in the starting project.
To do this, navigate to the `start` directory and run the `install` and `liberty:start-server` Maven goals:

```
cd ../start
mvn install
mvn liberty:start-server
```

Once the servers start, you can find the `system` and `inventory` services at:

- {sys-url}
- {inv-url}


include::{common-includes}/mvnpackage.adoc[]


// =================================================================================================
// Existing Tracer implementation
// =================================================================================================

== Existing Tracer implementation

In order to collect traces across your systems, you are required to implement the OpenTracing `Tracer`
interface. For the purposes of this guide, we are providing a bare-bones `Tracer` implementation for
the Zipkin server in a form of a user feature for Open Liberty.

This feature has already been configured for you and it will be installed automatically into each service
when you build them. You can find it enabled in your `server.xml` files:

[source, xml, role="no_copy"]
----
<feature>usr:opentracingZipkin-0.30</feature>
----

The user feature is pulled in and installed automatically using the following Maven plugin in `system/pom.xml` and
`inventory/pom.xml`:

[source, xml, role="no_copy"]
----
<groupId>com.googlecode.maven-download-plugin</groupId>
<artifactId>download-maven-plugin</artifactId>
<version>${version.download-maven-plugin}</version>
<executions>
    <execution>
        <id>install-tracer</id>
        <phase>prepare-package</phase>
        <goals>
            <goal>wget</goal>
        </goals>
        <configuration>
            <url>https://repo1.maven.org/maven2/net/wasdev/wlp/tracer/liberty-opentracing-zipkintracer/1.0/liberty-opentracing-zipkintracer-1.0-sample.zip</url>
            <unpack>true</unpack>
            <outputDirectory>${project.build.directory}/liberty/wlp/usr</outputDirectory>
        </configuration>
    </execution>
</executions>
</plugin>
----

Note, this user feature also comes with the `opentracing-1.0` feature, so you don't need to enable it
explicitly.

If you wish to install this feature yourself, then you can find the complete installation instructions in the
https://www.ibm.com/support/knowledgecenter/was_beta/com.ibm.websphere.wlp.nd.multiplatform.doc/ae/twlp_dist_tracing.html[IBM Knowledge Center].


// =================================================================================================
// Enabling distributed tracing
// =================================================================================================

== Enabling distributed tracing

While the OpenTracing feature (`opentracing-1.0`) found inside Open Liberty enables tracing of all JAX-RS methods by default,
MicroProfile OpenTracing allows you to control and customize these traces. Using the `@Traced` annotation
you can enable and disable tracing of particular methods. A custom `Tracer` object can also be injected
for creating and customizing spans.


=== Enabling distributed tracing with no code instrumentation

Since tracing of all JAX-RS methods is enabled by default, enabling MicroProfile OpenTracing and the
Zipkin user feature in the `server.xml` file is enough to see some basic traces in Zipkin.

Both of these features have already been enabled in `inventory/src/main/liberty/config/server.xml`
and `system/src/main/liberty/config/server.xml` files:

[source, xml, role="no_copy"]
----
<feature>mpOpentracing-1.0</feature>
<feature>usr:opentracingZipkin-0.30</feature>
----

Make sure your services are running, then simply point your browser to any of their endpoints and
check your Zipkin server for traces.


=== Enabling explicit distributed tracing

The `@Traced` annotation can be used to define explicit span creation for specific classes and methods.
If the annotation is placed on a class, then the annotation is automatically applied to all methods
within that class. If the annotation is placed on a method, then it overwrites the class annotation
if one exists.

The `@Traced` annotation can be configured with two parameters:

- `value=[true|false]` (true by default), indicates whether or not a particular class or method should
be traced. For example, while all JAX-RS methods are traced by default, you can disable tracing using
the `@Traced(false)` annotation.
- `operationName=<Span name>` indicates the name of the span assigned to the particular method being
traced. If omitting this parameter, the span will be named in form `<package name>.<class name>.<method name>`.
If placed on a class, all methods within that class will have the same span name unless explicitly
overwritten with another `@Traced` annotation.

Tweak the existing `inventory/src/main/java/io/openliberty/guides/inventory/InventoryManager.java` class
and enable tracing of the `list()` method:

[source, Java]
----
include::finish/inventory/src/main/java/io/openliberty/guides/inventory/InventoryManager.java[tags=**;!copyright;!custom-tracer]
----

Next, run the `mvn package` command from the `start` directory to rebuild your services. Point to {inv-url}, check your Zipkin
server, and you will see a new trace record of three spans long. Two spans for the `listContents()`
JAX-RS method in `InventoryResource.java` and another span for the `list()` method in `InventoryManager.java`:

image::/guides/draft-guide-microprofile-opentracing/resources/enable-tracing.png[png][Enable tracing, width=100%]

Now, tweak the existing `inventory/src/main/java/io/openliberty/guides/inventory/InventoryResource.java` class
and disable tracing of the `listContents()` JAX-RS method:

[source, Java]
----
include::finish/inventory/src/main/java/io/openliberty/guides/inventory/InventoryResource.java[tags=**;!copyright]
----

Again, run the `mvn package` command from the `start` directory to rebuild your services. Point to {inv-url}, check your Zipkin
server, and you will see a new trace record of just one span long for the remaining `list()` method
in `InventoryManager.java`:

image::/guides/draft-guide-microprofile-opentracing/resources/disable-tracing.png[png][Disable tracing, width=100%]


=== Injecting a custom Tracer object

The MicroProfile OpenTracing specification also makes the underlying OpenTracing `Tracer` instance
available for use. The configured `Tracer` can be accessed by injecting it using the `@Inject` annotation
from the CDI API.

Inject the `Tracer` object into `inventory/src/main/java/io/openliberty/guides/inventory/InventoryManager.java`.
Then use it to define a new child span in the `get()` method around the `addToInventoryList()` call:

[source, Java]
----
include::finish/inventory/src/main/java/io/openliberty/guides/inventory/InventoryManager.java[tags=**;!copyright]
----

Next, run the `mvn package` command from the `start` directory to rebuild your services. Point to {inv-url}, check your Zipkin
server, and you will see a new trace record of four spans long. The first two spans for the `getPropertiesForHost()`
method in `InventoryResource.java` and the third span for the `getProperties()` method in `SystemResource.java`.
The last span is the custom span you created around the `addToInventoryList()` call.

image::/guides/draft-guide-microprofile-opentracing/resources/inject-tracer.png[png][Inject tracer, width=100%]

This is just a simple example of what you can do with the injected `Tracer`. More configuration
options are available to you, including setting a timestamp for when the span was created and destroyed.
However, these require an implementation of their own, which does not come as a part of the Zipkin
user feature we've provided. In a real development environment, you would want to implement all the
necessary OpenTracing interfaces that you need yourself. This may include the `SpanBuilder` interface,
which can be used for span creation and customization, including setting their timestamps.


// =================================================================================================
// Testing the services
// =================================================================================================

== Testing the services

A few tests have been included for you to test the basic functionality of the services. If a test
failure occurs, then you must have introduced a bug into the code. These tests will run automatically
as a part of the Maven build process (when you run `mvn install`). You can also run these tests separately
from the build using the `mvn verify` command, but make sure that the servers are stopped beforehand.

No explicit tests exist to verify the correctness of the traces. These can be verified manually by viewing
them on the Zipkin server.


// =================================================================================================
// Great work! You're done!
// =================================================================================================

== Great work! You're done!

You have just utilized MicroProfile OpenTracing to customize how and what tracers are delivered to Zipkin.

Feel free to try one of the related MicroProfile guides. They demonstrate new technologies that you can learn and
expand on top what you built here.

include::{common-includes}/finish.adoc[]
