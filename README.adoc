// Copyright (c) 2017 IBM Corporation and others.
// Licensed under Creative Commons Attribution-NoDerivatives
// 4.0 International (CC BY-ND 4.0)
//   https://creativecommons.org/licenses/by-nd/4.0/
//
// Contributors:
//   IBM Corporation
:projectid: microprofile-opentracing
:page-layout: guide
:page-duration: 15 minutes
// :page-releasedate: 2017-12-11
:page-description: Learn how to enable and customize tracing of JAX-RS and non JAX-RS methods using MicroProfile OpenTracing.
:page-tags: ['MicroProfile', 'OpenTracing']
:page-permalink: /guides/{projectid}
:page-related-guides: ['cdi-intro']
:common-includes: https://raw.githubusercontent.com/OpenLiberty/guides-common/master
:source-highlighter: prettify
= Enabling distributed tracing in MicroProfile applications

Learn how to enable and customize tracing of JAX-RS and non JAX-RS methods using MicroProfile OpenTracing.

== What you'll learn

You will learn how to enable automatic tracing for JAX-RS methods as well as create custom tracers
for non JAX-RS methods using MicroProfile OpenTracing.

OpenTracing is a standard API for instrumenting microservices for distributed tracing. Distributed
tracing helps troubleshoot microservices by examining and logging requests as they propagate through a
distributed system, allowing developers to tackle otherwise difficult task of debugging these requests.
Without a distributed tracing system in place, it becomes extremely difficult to analyze the workflows of
operations, in particular, being able to pinpoint when and by whom a request is received, as well as
when a response is sent back.

MicroProfile OpenTracing aims to enable distributed tracing in MicroProfile applications without having
to add any explicit distributed tracing code to the application.Note that the MicroProfile OpenTracing
specification does not address the problem of defining, implementing, or configuring the underlying
distributed tracing system. Rather, it makes it easy to instrument services with distributed tracing
given an existing distributed tracing system.

You will configure the provided `inventory` and `system` services to make use of distributed tracing
using MicroProfile OpenTracing. You will run these services in two separate JVMs (two server instances)
in order to better demonstrate tracing in a distributed environment. If everything were to run on a single
server, then any logging software would do the trick.


// =================================================================================================
// Getting Started
// =================================================================================================

include::{common-includes}/gitclone.adoc[]

For the purposes of this guide, we are using Zipkin as our distributed tracing system. You can find the
installation instructions for Zipkin https://zipkin.io/pages/quickstart.html[here]. You are not
restricted to using Zipkin, but keep in mind that you may need additional instructions not listed here
if you choose to use another tracing system.

Before you proceed, make sure your Zipkin server (or another tracing system of your choice) is up and running.
Our Zipkin instance can be found at http://localhost:9411.

=== Try what you'll build

The `finish` directory in the root directory of this guide contains two services that have been configured
to use MicroProfile OpenTracing. Feel free to give them a try before you proceed.

To try out the services, first navigate to the `finish` directory and then execute the following
Maven goals to build the services and run them in two instances of Open Liberty:

```
mvn install liberty:start-server
```

Point your browser to {inv-url}. When you visit this endpoint, you make a GET HTTP request to the `inventory` service.
This GET request is configured to be traced, and therefore a new trace entry of one span long will appear
in your Zipkin server. Navigate to your Zipkin server to verify this. Next, point to {inv-url}/localhost.
This will make two GET requests: one to the `inventory` service and one to the `system` service. Both
of these requests are configured to be traced. Visit your Zipkin server to verify that a new trace of
two spans long has been logged. You can also inspect each trace for more detailed information such as
the time at which the request was received and the time at which a response was sent back.

Once you are done checking out the services, stop both Open Liberty servers:

```
mvn liberty:stop-server
```

Now, navigate back to the `start` directory to begin.


// =================================================================================================
// Running the application with Docker
// =================================================================================================

== Running with Docker (optional)

This step is entirely up to you. If you are using Docker to run your Zipkin server and you would prefer
running your services with Docker as well, then ignore the steps in <<Building the application>> and
follow these instructions instead:

A `Dockerfile` and a `docker-compose.yaml` are provided under the `docker` directory in the root directory
of this guide. Navigate to this directory and run `mvn package` to build your services. Next, make sure
your Zipkin container is stopped and run `docker-compose up -d`. This will create and start three containers:
one for the `system` service, one for the `inventory` service, and one for the Zipkin server. Once the
containers are running, the `inventory` service can be reached at {inv-url}
and the Zipkin server at http://localhost:9441. To retrieve the JVM system properties of the container
running the `system` service, point to {inv-url}/sys (all containers are
  linked and therefore they can access each other by their container names).


// =================================================================================================
// Building the application
// =================================================================================================

include::{common-includes}/mvnbuild.adoc[]

You can find the `inventory` and `system` services at:

:inv-url: http://localhost:9081/inventory/systems
:sys-url: http://localhost:9080/system/properties

- {inv-url}
- {sys-url}

include::{common-includes}/mvnpackage.adoc[]


// =================================================================================================
// Existing Tracer implementation
// =================================================================================================

== Existing Tracer implementation

Normally, you need to have a OpenTracing Tracer implementation in your application for MicroProfile OpenTracing
to take advantage of it. Luckily, we are providing a simple user feature that contains this implementation
for the Zipkin server.

This feature has already been configured for you and it will be installed automatically into each service
when you build them. You can find it enabled in your `server.xml`:

[source, xml, role="no_copy"]
----
<feature>usr:opentracingZipkin-0.30</feature>
----

The feature is pulled in and installed automatically using this plugin in your `system/pom.xml` and
`inventory/pom.xml`:

[source, xml, role="no_copy"]
----
<groupId>com.googlecode.maven-download-plugin</groupId>
<artifactId>download-maven-plugin</artifactId>
<version>${version.download-maven-plugin}</version>
<executions>
    <execution>
        <id>install-tracer</id>
        <phase>prepare-package</phase>
        <goals>
            <goal>wget</goal>
        </goals>
        <configuration>
            <url>https://repo1.maven.org/maven2/net/wasdev/wlp/tracer/liberty-opentracing-zipkintracer/1.0/liberty-opentracing-zipkintracer-1.0-sample.zip</url>
            <unpack>true</unpack>
            <outputDirectory>${project.build.directory}/liberty/wlp/usr</outputDirectory>
        </configuration>
    </execution>
</executions>
</plugin>
----

If you wish to install this feature yourself, then you can find the complete installation instructions in the
https://www.ibm.com/support/knowledgecenter/was_beta/com.ibm.websphere.wlp.nd.multiplatform.doc/ae/twlp_dist_tracing.html[IBM Knowledge Center].


// =================================================================================================
// Enabling distributed tracing
// =================================================================================================

== Enabling distributed tracing

The MicroProfile OpenTracing feature comes with three main functionalities: automatic tracing of JAX-RS
methods, the `@Traced` annotation for tracing custom methods, and the injectable Tracer instance for
additional Span customization.


=== Enabling distributed tracing with no code instrumentation

Tracing of all JAX-RS methods is enabled by default. Hence, once you enable the MicroProfile OpenTracing feature,
tracing of all JAX-RS methods will be automatic without needing any additional distributed tracing code.

The MicroProfile OpenTracing feature has already been enabled in your `server.xml`:

[source, xml, role="no_copy"]
----
<feature>mpOpentracing-1.0</feature>
----

At this point, you can start the `system` and `inventory` services as well as the Zipkin server and
your traces will get logged.


=== Enabling explicit distributed tracing code instrumentation

The `@Traced` annotation can be used to define explicit Span creation for specific classes and methods.
If the annotation is placed on a class, then the annotation is automatically applied to all methods
within that class. If the annotation is placed on a method, then it overwrites the class annotation
if one exists.

The `@Traced` annotation can be configured with two parameters:

- `value=[true|false]` (true by default), indicates whether or not a particular class or method should
be traced. For example, while all JAX-RS methods are traced by default, you can disabling tracing for
any such method using the `@Traced(false)` annotation.
- `operationName=<Span name>` ("" by default), indicates the name of the span assigned to the particular
method being traced. When omitting this parameter, the Span will be named in form
`<package name>.<class name>.<method name>`. If placed on a class, all methods within that class
will have the same Span name unless explicitly overwritten with another `@Traced` annotation.

Tweak `inventory/src/main/java/io/openliberty/guides/inventory/InventoryManager.java` and add a
`@Traced(value = true, operationName = "InventoryManager.list")` annotation onto the `list()` method
to enable tracing of this method:

[source, Java]
----
include::finish/inventory/src/main/java/io/openliberty/guides/inventory/InventoryManager.java[tags=**;!copyright;!inject-tracer]
----

Next, run the `mvn package` command from the `start` directory to rebuild your services. Point to {inv-url}
(refresh the page) and then navigate to your Zipkin server and you will see a new trace of two spans long,
containing a Span for the `listContents()` JAX-RS method in `InventoryResource.java` and another Span
for the `list()` method in `InventoryManager.java`:

image::resources/enable-tracing.png[png][Enable tracing, float=left]

Tweak `inventory/src/main/java/io/openliberty/guides/inventory/InventoryResource.java` and add a `@Traced(false)`
annotation onto the `listContents()` method to disable tracing for this JAX-RS method:

[source, Java]
----
include::finish/inventory/src/main/java/io/openliberty/guides/inventory/InventoryResource.java[tags=**;!copyright]
----

Then, run `mvn package` to rebuild your services and point to {inv-url}
(refresh the page). Next, navigate to your Zipkin server and you will see a new trace of one span
long for the remaining `list()` method in `InventoryManager.java`:

image::resources/disable-tracing.png[png][Disable tracing, float=left]

=== Injecting and customizing a Tracer object

The MicroProfile OpenTracing specification also makes the underlying OpenTracing Tracer instance available for
the developer's use. The configured Tracer can be accessed by injecting it into a bean using the `@Inject`
annotation from the CDI API.

Inject a Tracer object into `inventory/src/main/java/io/openliberty/guides/inventory/InventoryManager.java`.
Then as an example, use it to define a new child span in the `get()` method around the `addToInventoryList` call.
This new span will show exactly how long it takes to complete that call:

[source, Java]
----
include::finish/inventory/src/main/java/io/openliberty/guides/inventory/InventoryManager.java[tags=**;!copyright]
----

Rebuild your application using `mvn package` as before and point to {inv-url}. A new trace of two spans
long will be recorded in your Zipkin server. The first (parent) Span is for the is the custom `InventoryManager.list` Span
you created earlier and the second is for the new (child) Span that you just created:

image::resources/inject-tracer.png[png][Inject tracer, float=left]

This is just a simple example of what you can do with the injected Tracer object. You can find out
more configuration options by reading the official io.opentracing API.


== Great work! You're done!

You have just utilized MicroProfile OpenTracing to customize how and what tracers are delivered to Zipkin.

Feel free to try one of the related MicroProfile guides. They demonstrate new technologies that you can learn and
expand on top what you built here.

include::{common-includes}/finish.adoc[]
